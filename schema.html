<!DOCTYPE html>

<html>
<head>
  <title>schema.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="https://cdn.jsdelivr.net/npm/docco-next@0.9.3/layouts/parallel/docco.css" />
  <style>
    h1,h2,h3,h4,h5 {
      text-transform: none;
    }
    div.annotation pre {
        margin: 15px 0 15px;
        padding-left: 15px;
        background: #f5f5fe;
        box-shadow: none;
        border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>schema.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h2 id="createstore">createStore</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>you can then attach queries to it and observe them for changes. To unobserver the call the function returned by observe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> {
  IQBase,
  ITableDefinition,
  ISelectQuery,
  ISchemaDefinition,
  IManyToMany,
  R,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./types&quot;</span>;
<span class="hljs-keyword">import</span> { observe } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./watch&quot;</span>;
<span class="hljs-keyword">import</span> { DB, defDb <span class="hljs-keyword">as</span> createDb } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./relational&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStore</span>(<span class="hljs-params">schema: ISchemaDefinition</span>): <span class="hljs-title">IQBase</span> </span>{
  <span class="hljs-keyword">const</span> db = createDb();
  schema.tables.forEach(<span class="hljs-function">(<span class="hljs-params">table</span>) =&gt;</span> {
    createTable(db, table);
  });
  <span class="hljs-keyword">const</span> queryHandlers = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">Function</span>&gt;&gt;();
  <span class="hljs-keyword">const</span> queries = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">string</span>, [ISelectQuery, <span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>]&gt;();
  <span class="hljs-keyword">const</span> compiledSchema = {};
  <span class="hljs-keyword">const</span> store: IQBase = {
    db,
    compiledSchema,
    queryHandlers,
    queries,
    schema,
  };
  schema.tables.forEach(<span class="hljs-function">(<span class="hljs-params">table</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>compileSchema(store, table);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  });
  <span class="hljs-keyword">return</span> store;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>export function compileSchema(db: IQBase, tableDefintion: ITableDefinition) {}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTable</span>(<span class="hljs-params">db: DB, tableDefinition: ITableDefinition</span>) </span>{
  db.state[tableDefinition.name] = {
    <span class="hljs-attr">checksums</span>: {},
    <span class="hljs-attr">value</span>: {},
  };
  (tableDefinition.relations || []).forEach(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (el.type === R.MTM &amp;&amp; el.opts.through) {
      <span class="hljs-keyword">const</span> thoughTableName = el.opts.through;
      <span class="hljs-keyword">if</span> (!db.state[thoughTableName]) {
        db.state[thoughTableName] = {
          <span class="hljs-attr">checksums</span>: {},
          <span class="hljs-attr">value</span>: {},
        };
      }
    }
  });
  <span class="hljs-keyword">return</span> tableDefinition;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
